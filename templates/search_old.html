{% extends "base.html" %}
{% block content %}

<form id="form" class="form-inline" >
  <input id="search" class="form-control w-75 mr-sm-2" type="text" placeholder="토렌트 검색" aria-label="Search">
  <button id="submit" class="btn btn-outline-success my-2 my-sm-0" type="submit">검색</button>
</form>
<div class="d-inline-block"></div>
<table id="result_table" class="table table-striped table-sm tableRowHover">
  <thead>
    <tr>
      <th style="width:5%">Indexer</th>
      <th style="width:10%">게시판</th>
      <th style="width:10%">#</th>
      <th style="width:65%">제목</th>
      <th style="width:10%">날짜</th>
    </tr>
  </thead>
  <tbody id="list" >
  </tbody>
</table>

<script type="text/javascript">
$(document).ready(function() {
  $("#form").submit(function(e) {
    var search_word = $("#search").val();
    if(typeof(EventSource)!=="undefined") {
      var source=new EventSource("/api/search?keyword=" + search_word);
      document.getElementById("list").innerHTML = "";
      source.onmessage=function(event) {
        if (event.data == -1) source.close();
        else {
          var data = JSON.parse(event.data);
          for (var i = 0 ; i < data.list.length; i++) {
            str = '<tr style="cursor: pointer;" class="clickable" data-toggle="collapse" data-target="#collapse_' + data.list[i].b_id + '_' + data.list[i].id + '" aria-hidden="true" data-id=' + data.list[i].id  + ' data-b_id=' + data.list[i].b_id +'>';
            str += '<td scope="col">'+ data.list[i].indexer + '</td>';
            str += '<td scope="col">'+ data.list[i].kor_title + '</td>';
            str += '<td scope="col">'+ data.list[i].num + '</td>';
            str += '<td scope="col">'+ data.list[i].title + '</td>';
            str += '<td scope="col">'+ data.list[i].date + '</td>';
            str += '</tr>'
            document.getElementById("list").innerHTML += str;
          }
        }
      };
    }
    e.preventDefault();
  });
});

$(document).ready(function() {
  $('#result_table').on('click', function(e) {
    e.preventDefault();
    //btn : td, row:tr
    var $btn = $(e.target), $row = $btn.closest('tr'), $nextRow = $row.next('tr.expand-child');
    if ($nextRow.length) {
      $nextRow.toggle();
    } else {
      if ($row.data('id') != null) {
        $.ajax({
          url: '/api/torrent_detail',
          type: "POST",
          cache: false,
          data:{ indexer:'tm', b_id: $row.data('b_id'), id:$row.data('id') },
          dataType: "json",
          success: function (parentsData) {
            console.log(parentsData);
              var newRow = '<tr style="cursor: pointer;" class="clickable expand-child tableRowHoverOff" id="collapse_' + $row.data('b_id') + '_' + $row.data('id') + '">' +
                '<td colspan="1"></td><td colspan="5">' +
                '<table class="table table-condensed table-bordered" width=100% >' +
                '<thead class="thead-dark">' +
                '<tr>' +
                '<th width=10%>no</th>' +
                '<th width=70%>파일명</th>' +
                '<th width=10%>Size</th>' +
                '<th width=10%>다운로드</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';
              
              if (parentsData.data) {
                $.each(parentsData.data, function(i, parent) {
                  rowspan = (parent.filelist.length == 0) ? 1 : 3;
                  newRow += '<tr class="tableRowHoverOff">'
                  newRow += '<tr class="tableRowHoverOff">'
                  newRow += '<td rowspan=' + rowspan + '>' + (parent.index+1) + '</td>';
                  newRow += '<td>' + parent.title  + '</td>';
                  newRow += '<td>' + parent.size + '</td>';
                  newRow += '<td rowspan=' + rowspan + '>' + '<button type="button" class="btn btn-info btn-sm">다운로드</button></td></tr>';

                  if (rowspan == 3) {
                    newRow += '<tr class="tableRowHoverOff"><td>' + parent.magnet_url  + '</td><td></td></tr>';
                    newRow += '<tr class="tableRowHoverOff"><td>';
                    for (var i = 0 ; i < parent.filelist.length; i++) {
                      if ( i != 0 ) newRow += '<br>'
                      newRow += parent.filelist[i].filename
                    }
                    newRow += '</td><td>';
                    for (var i = 0 ; i < parent.filelist.length; i++) {
                      if ( i != 0 ) newRow += '<br>'
                      newRow += parent.filelist[i].size;
                    }
                    newRow += '</td></tr>';
                  }
                  
                  
                });
              }
              newRow += '</tbody></table></td><td colspan="1"></td></tr>';
              // set next row
              $nextRow = $(newRow).insertAfter($row);
          }
        });
      }
    }
  })});

/*
$(document).ready(function() {
  $("#form").submit(function(e) {
    var search_word = $("#search").val();
    var qurl="/api/search";
    $.ajax({
      type: "POST",
      cache: false,
      data:{keyword:search_word},
      url: qurl,
      dataType: "json",
      beforeSend: function() {
        //alert('inside ajax');
      },
      success: function(data) { 
        $('#list').html('');
        var str = '';
        for (var i = 0 ; i < data.list.length; i++) {
          str = '<tr>'
          str += '<td scope="col">'+ data.list[i].num + '</td>';
          str += '<td scope="col">'+ data.list[i].title + '</td>';
          str += '<td scope="col">'+ data.list[i].date + '</td>';
          str += '</tr>'
          $('#list').append(str);
        }
      },
      error: function(jqXHR) {
        alert("error: " + jqXHR.status);
        console.log(jqXHR);
      },
      complete:function(jqXHR, textStatus) {
        //alert('completed with either success or fail');
      }
    })
    e.preventDefault();
  });
});
*/
</script>    
{% endblock %}